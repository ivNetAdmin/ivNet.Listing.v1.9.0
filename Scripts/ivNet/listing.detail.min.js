
var ListingDetail = angular.module('ivNet.ListingDetail', ['ngResource', 'trNgGrid', 'ngSanitize'])

ListingDetail.factory('listingDetail', function ($resource) {
    return $resource('/api/listing/listing/:id', null,
    {
        'query': { method: 'GET', isArray: false },
    });
});

ListingDetail.controller('ListingsController', function($scope, listingDetail) {

    init();

    $scope.showSearchResults = function () {
        window.location.replace("/ivNet.Listing/site/search?q=" + $scope.searchterm);
    };

    function init() {
        $('div#throbber').addClass('throbber-loader');

        // get listing id from query string
        var idParts = window.location.search.substr(1).split('=');
        var listingId = idParts[1];

        listingDetail.query({ id: listingId },
            function(data) {
                $scope.data = data;
                $scope.price = unescape(data.Price);
                $scope.rooms = jQuery.parseJSON(data.Rooms);
                $scope.theatres = jQuery.parseJSON(data.Theatres);
                $scope.searchterm = data.SearchTerm;
                buildLightbox();
                buildMap();
                buildTags()

                $('div#throbber').removeClass('throbber-loader');
            },
            function(error) {
                alert(error.data.Message + ' [' + error.data.MessageDetail + ']');
                $('div#throbber').removeClass('throbber-loader');
            });

    };

    function buildLightbox() {
        var imageList = jQuery.parseJSON($scope.data.Images);

        //var active = " active";

        var thumbnails = $('ul.thumbnails');

        //var indicators = $('ol.carousel-indicators');

        $.each(imageList, function(index, value) {
            var li = $('<li/>', {
                'class': 'col-md-3'
            }).appendTo(thumbnails);

            var a = $('<a/>', {
                'class': 'thumbnail',
                'rel': 'lightbox[group]',
                'href': value.File
            }).appendTo(li);

            $('<img/>', {
                'class': 'group1',
                'alt': value.Alt,
                'src': value.File
            }).appendTo(a);

        });

        $("[rel^='lightbox']").prettyPhoto();
    };

    function buildMap() {
        if ($scope.data.Latitude != 0) {
            try {

                var var_location = new google.maps.LatLng($scope.data.Latitude, $scope.data.Longitude);

                var var_mapoptions = {
                    center: var_location,
                    zoom: 11
                };

                var var_marker = new google.maps.Marker({
                    position: var_location,
                    map: var_map,
                    title: $scope.data.Town + ", " + $scope.data.Postcode
                });

                var var_map = new google.maps.Map(document.getElementById("map-container"),
                    var_mapoptions);

                var_marker.setMap(var_map);
            } catch (ex) {
            }
        }
    }

    function buildTags() {
        taglist = jQuery.parseJSON($scope.data.Tags);
        var tags = $('ul.tags');

        jQuery.each(taglist, function (index, item) {
            var li = $('<li/>', {
                'class': 'col-md-1'
            }).appendTo(tags);

            $('<button/>', {
                'text': item.Name
            }).appendTo(li);
        });

        $('ul.tags button').bind('click',function() {
            $('input#tagq').val($(this)[0].innerText)
            $('form#tagSearch').submit();
        });        
    }
});